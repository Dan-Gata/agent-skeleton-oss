# Agent Orchestrateur - Documentation Compl√®te

## üéØ Objectif

Orchestrateur Node.js/Express pour automatiser la cr√©ation de contenu, les d√©ploiements et la gestion multi-plateforme via:
- **n8n** : Workflows de cr√©ation (Content Creator, Brain Rotter 5000)
- **Coolify** : D√©ploiements automatis√©s
- **Baserow** : Stockage m√©tadonn√©es et assets
- **Toolkit Vid√©o** : G√©n√©ration TTS, captions, montage
- **R√©seaux Sociaux** : Publication YouTube, TikTok, Instagram, X, LinkedIn, Pinterest, Threads

## üèóÔ∏è Architecture

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ             ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ              ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ   n8n       ‚îÇ
‚îÇ Utilisateur ‚îÇ     ‚îÇ Orchestrateur‚îÇ     ‚îÇ  Workflows  ‚îÇ
‚îÇ             ‚îÇ‚óÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ   Express    ‚îÇ‚óÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚îÇ
                           ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂ Coolify (D√©ploiements)
                           ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂ Baserow (Assets)
                           ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂ Toolkit Vid√©o
                           ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂ R√©seaux Sociaux (via n8n)
```

## üöÄ D√©marrage Rapide

### Installation

```powershell
# Cloner le repo
git clone https://github.com/Dan-Gata/agent-skeleton-oss.git
cd agent-skeleton-oss/packages/orchestrator

# Installer les d√©pendances
npm install

# Configurer l'environnement
cp .env.example .env
# √âditez .env avec vos valeurs
```

### Configuration `.env`

```env
PORT=3000
NODE_ENV=development

# n8n
N8N_API_URL=https://n8n.votre-domaine.tld
N8N_API_KEY=votre-cl√©-api

# Coolify
COOLIFY_API_URL=https://coolify.votre-domaine.tld
COOLIFY_API_KEY=votre-token

# Baserow
BASEROW_URL=http://baserow:80
BASEROW_API_TOKEN=votre-token

# Toolkit Vid√©o
VIDEO_TOOLKIT_URL=http://video-toolkit:8080
```

### Lancement

```powershell
# D√©veloppement (avec hot-reload)
npm run dev

# Production
npm start

# Tests
npm test
```

Acc√©dez √†: `http://localhost:3000`

## üì° API Endpoints

### Syst√®me

| M√©thode | Endpoint | Description |
|---------|----------|-------------|
| GET | `/` | Dashboard principal |
| GET | `/health` | √âtat des services |
| GET | `/login` | Page de connexion |
| POST | `/api/login` | Authentification |

### n8n - Workflows

| M√©thode | Endpoint | Description |
|---------|----------|-------------|
| POST | `/trigger/n8n/:webhookPath` | D√©clencher workflow via webhook |
| POST | `/run/:workflowId` | Ex√©cuter workflow via REST API |

**Exemples:**
```powershell
# Content Creator
curl -X POST http://localhost:3000/trigger/n8n/content-creator \
  -H "Content-Type: application/json" \
  -d '{"topic": "IA", "platform": "YouTube"}'

# Brain Rotter 5000
curl -X POST http://localhost:3000/trigger/n8n/brain-rotter \
  -H "Content-Type: application/json" \
  -d '{"topic": "Fun Facts", "duration": 60}'
```

### Coolify - D√©ploiements

| M√©thode | Endpoint | Description |
|---------|----------|-------------|
| POST | `/coolify/deploy/:serviceId` | D√©clencher d√©ploiement |

**Exemple:**
```powershell
curl -X POST http://localhost:3000/coolify/deploy/app-123
```

### Baserow - Assets

| M√©thode | Endpoint | Description |
|---------|----------|-------------|
| POST | `/baserow/upload` | Upload donn√©es vers table |
| GET | `/baserow/assets?tableId=123` | R√©cup√©rer assets |

**Exemples:**
```powershell
# Upload
curl -X POST http://localhost:3000/baserow/upload \
  -H "Content-Type: application/json" \
  -d '{"tableId": "123", "data": {"name": "Vid√©o 1"}}'

# R√©cup√©ration
curl "http://localhost:3000/baserow/assets?tableId=123"
```

### Toolkit Vid√©o

| M√©thode | Endpoint | Description |
|---------|----------|-------------|
| POST | `/video/generate` | G√©n√©rer vid√©o (TTS, captions, etc.) |

**Exemple:**
```powershell
curl -X POST http://localhost:3000/video/generate \
  -H "Content-Type: application/json" \
  -d '{
    "text": "Contenu vocal",
    "voice": "fr-FR-Neural",
    "addCaptions": true
  }'
```

## üîß Configuration n8n

### Workflows √† Cr√©er

#### 1. Content Creator
- **Webhook:** `/webhook/content-creator`
- **Fonction:** G√©n√®re des id√©es de contenu au ton de marque
- **Tools requis:** GET BRAND BRIEFLY, feedback tools

#### 2. Brain Rotter 5000
- **Webhook:** `/webhook/brain-rotter`
- **Fonction:** G√©n√®re vid√©os virales courtes
- **Int√©grations:** Toolkit vid√©o, Baserow, r√©seaux sociaux

#### 3. Social Publisher
- **Webhook:** `/webhook/social-publish`
- **Fonction:** Publication multi-plateformes
- **Plateformes:** YouTube, TikTok, Instagram, X, LinkedIn, Pinterest, Threads

### Credentials n8n √† Configurer

Dans n8n Settings ‚Üí Credentials, ajoutez:

1. **Baserow**
   - Type: HTTP Header Auth
   - Name: Authorization
   - Value: `Token votre-token`

2. **YouTube**
   - Type: OAuth2 API
   - Scopes: upload, analytics

3. **TikTok**
   - Type: TikTok API
   - Credentials selon docs TikTok

4. **Instagram**
   - Type: Instagram Graph API
   - Token d'acc√®s

5. **X/Twitter**
   - Type: Twitter OAuth 1.0a

6. **LinkedIn**
   - Type: LinkedIn OAuth2

7. **Pinterest**
   - Type: Pinterest OAuth2

## üê≥ D√©ploiement Coolify

### 1. Pr√©parer le Repo

```powershell
# V√©rifier la structure
tree /F packages/orchestrator
```

Doit contenir:
- ‚úÖ `Dockerfile`
- ‚úÖ `.dockerignore`
- ‚úÖ `package.json`
- ‚úÖ `src/index.js`

### 2. Cr√©er l'Application Coolify

1. **Coolify** ‚Üí **New Resource** ‚Üí **Application**
2. **Source:** GitHub
3. **Repository:** `https://github.com/Dan-Gata/agent-skeleton-oss`
4. **Base Directory:** `packages/orchestrator`
5. **Build Pack:** Dockerfile
6. **Port:** 3000

### 3. Configurer les Variables

Dans Coolify ‚Üí App Settings ‚Üí Environment Variables:

```env
PORT=3000
NODE_ENV=production
N8N_API_URL=https://n8n.kaussan-air.org
N8N_API_KEY=***
COOLIFY_API_URL=https://kaussan-air.org
COOLIFY_API_KEY=***
BASEROW_URL=http://baserow:80
BASEROW_API_TOKEN=***
VIDEO_TOOLKIT_URL=http://video-toolkit:8080
```

### 4. D√©ployer

1. Cliquez sur **Deploy**
2. Surveillez les logs
3. Testez `/health` une fois d√©ploy√©
4. Configurez le domaine/SSL (g√©r√© automatiquement par Coolify)

## üîí S√©curit√©

### Best Practices

1. **Secrets**
   - ‚ùå Ne jamais commiter `.env`
   - ‚úÖ Utiliser variables d'environnement Coolify
   - ‚úÖ R√©g√©n√©rer tokens r√©guli√®rement
   - ‚úÖ Stocker dans un coffre de secrets

2. **Endpoints**
   - ‚úÖ HTTPS partout (g√©r√© par Coolify)
   - ‚úÖ Rate limiting sur endpoints publics
   - ‚úÖ Authentification API (middleware √† impl√©menter)
   - ‚úÖ IP allowlist si n√©cessaire

3. **Logs**
   - ‚úÖ Ne pas logger les secrets
   - ‚úÖ Sanitizer les donn√©es utilisateur
   - ‚úÖ Monitoring centralis√©

### Middleware d'Authentification (√Ä Impl√©menter)

```javascript
// Exemple de protection des endpoints sensibles
const authenticateAPI = (req, res, next) => {
    const apiKey = req.headers['x-api-key'];
    if (!apiKey || apiKey !== process.env.INTERNAL_API_KEY) {
        return res.status(401).json({ error: 'Unauthorized' });
    }
    next();
};

app.post('/trigger/n8n/:webhookPath', authenticateAPI, async (req, res) => {
    // Endpoint prot√©g√©
});
```

## üß™ Tests

### Tests Unitaires

```powershell
npm test
```

### Tests Manuels

Voir [TESTING.md](./TESTING.md) pour exemples d√©taill√©s.

```powershell
# Health check
curl http://localhost:3000/health

# Test n8n webhook
curl -X POST http://localhost:3000/trigger/n8n/test \
  -H "Content-Type: application/json" \
  -d '{"test": "data"}'
```

## üêõ D√©pannage

### Erreurs Courantes

#### 1. Webhook n8n 404 GET
**Probl√®me:** URL ouverte dans navigateur (GET au lieu de POST)
**Solution:** Utiliser POST via curl/Postman

#### 2. host.docker.internal introuvable
**Probl√®me:** URL de dev en production
**Solution:** Remplacer par nom de service (`http://baserow:80`) ou URL publique

#### 3. 401/403 Coolify
**Probl√®me:** Token invalide
**Solution:** V√©rifier `COOLIFY_API_KEY` et permissions

#### 4. √âchec build Docker
**Probl√®me:** Dockerfile ou structure incorrecte
**Solution:** V√©rifier `COPY`, `WORKDIR`, `EXPOSE`, pr√©sence de `package.json`

### Logs de Debugging

```javascript
// Format standardis√© dans index.js
console.log(`[${new Date().toISOString()}] [service] Message`);
```

Exemple:
```
[2025-10-11T10:30:45.123Z] [n8n-webhook] D√©clenchement: content-creator
[2025-10-11T10:30:46.456Z] [n8n-webhook] ‚úÖ Succ√®s
```

## üìä Monitoring

### Health Check D√©taill√©

`GET /health` retourne l'√©tat de tous les services:

```json
{
  "status": "healthy",
  "services": {
    "n8n": { "configured": true, "url": "...", "hasApiKey": true },
    "coolify": { "configured": true, "url": "...", "hasApiKey": true },
    "baserow": { "configured": true, "url": "...", "hasToken": true },
    "videoToolkit": { "configured": true, "url": "..." }
  },
  "endpoints": {
    "n8n": [...],
    "coolify": [...],
    "baserow": [...],
    "video": [...]
  }
}
```

## üö¶ Roadmap

### Phase 1 - ‚úÖ Compl√©t√©
- [x] Endpoints n8n (webhook + REST)
- [x] Endpoints Coolify (deploy)
- [x] Endpoints Baserow (upload + get)
- [x] Endpoint Toolkit Vid√©o
- [x] Health check am√©lior√©

### Phase 2 - üîÑ En cours
- [ ] Workflows orchestr√©s (Content Creator complet)
- [ ] Authentification API s√©curis√©e
- [ ] Rate limiting
- [ ] Syst√®me de queues (retry, backoff)

### Phase 3 - üìã Planifi√©
- [ ] Dashboard analytics
- [ ] A/B testing titres/vignettes
- [ ] G√©n√©ration chapitres automatique
- [ ] R√©ponses auto aux commentaires
- [ ] WebSockets temps r√©el

## üìö Ressources

- [Documentation n8n](https://docs.n8n.io)
- [API Coolify](https://coolify.io/docs/api)
- [API Baserow](https://baserow.io/docs/apis/rest-api)
- [Guide Copilot](.github/copilot-instructions.md)
- [Guide de Tests](./TESTING.md)

## ü§ù Contribution

1. Fork le projet
2. Cr√©er une branche feature (`git checkout -b feature/AmazingFeature`)
3. Commit les changements (`git commit -m 'Add AmazingFeature'`)
4. Push vers la branche (`git push origin feature/AmazingFeature`)
5. Ouvrir une Pull Request

## üìÑ Licence

MIT License - Voir [LICENSE](../../LICENSE)

## üìû Support

- **Issues:** https://github.com/Dan-Gata/agent-skeleton-oss/issues
- **Discussions:** https://github.com/Dan-Gata/agent-skeleton-oss/discussions
